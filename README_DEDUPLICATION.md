# TTS 服务内容去重功能

## 🔄 功能概述

TTS 服务现已集成智能内容去重功能，可以在缓存之前自动识别并去除重复的内容，显著提高处理效率，减少不必要的语音合成操作。

## ✨ 主要特性

- **🔍 自动检测重复**: 根据文本内容、语音、语速、音量、音调自动识别重复项目
- **📋 详细去重报告**: 提供去重过程的详细信息和效率统计
- **🎵 智能音频重建**: 确保最终合成的音频序列与原始顺序完全一致
- **⚡ 性能优化**: 大幅减少重复合成，节省计算资源和时间

## 🚀 使用方法

### 批量 TTS API

去重功能会自动应用于所有批量 TTS 请求，无需额外配置。

```bash
curl -X POST http://localhost:5000/api/batch_tts \
  -H "Content-Type: application/json" \
  -d '{
    "items": [
      {"text": "扇風機", "voice": "ja-JP-NanamiNeural"},
      {"text": "こんにちは", "voice": "ja-JP-NanamiNeural"},
      {"text": "扇風機", "voice": "ja-JP-NanamiNeural"},
      {"text": "ゼン", "voice": "ja-JP-NanamiNeural"},
      {"text": "ゼン", "voice": "ja-JP-NanamiNeural"}
    ],
    "output_name": "test_dedup.wav",
    "audio_format": "wav"
  }'
```

### 响应示例

```json
{
  "success": true,
  "download_url": "http://localhost:5000/static/audio/test_dedup.wav",
  "filename": "test_dedup.wav",
  "items_processed": 5,
  "unique_items_synthesized": 3,
  "audio_format": "wav",
  "generation_time": 2.34,
  "processing_mode": "concurrent",
  "engine": "azure",
  "deduplication_info": {
    "duplicate_items_found": 2,
    "efficiency_gain_percent": 40.0,
    "description": "通过去重减少了 2 次重复合成，效率提升 40.0%"
  },
  "performance_info": "⚡ 并发处理 5 个音频文件 (wav), 用时 2.34 秒 (预估提速 1.7x) + 去重优化 40.0%"
}
```

## 📊 去重逻辑

### 去重标识

系统根据以下参数的组合来判断内容是否重复：

- `text`: 文本内容
- `voice`: 语音模型
- `rate`: 语速
- `volume`: 音量
- `pitch`: 音调

只有当所有参数完全相同时，才被视为重复内容。

### 处理流程

1. **📝 内容分析**: 扫描所有输入项目，生成唯一标识键
2. **🔍 重复检测**: 识别重复项目并建立映射关系
3. **⚡ 优化合成**: 只对唯一内容进行 TTS 合成
4. **🎵 序列重建**: 根据映射关系重建完整的音频序列
5. **📋 效率统计**: 计算并报告去重效果

## 📈 性能优势

### 示例场景

假设您有一个包含重复内容的批量请求：

```
原始项目: 10 个
- "欢迎使用" x 3次
- "请稍等" x 2次
- "谢谢" x 3次
- "再见" x 2次

去重后项目: 4 个
效率提升: 60%
```

### 实际效果

- **⏱️ 时间节省**: 减少 60% 的合成时间
- **💾 缓存效率**: 减少重复的缓存操作
- **📶 网络优化**: 减少对 Azure TTS API 的调用
- **💰 成本节约**: 降低 API 使用费用

## 🧪 测试去重功能

使用提供的测试脚本验证去重功能：

```bash
# 确保TTS服务正在运行
python start_new.py

# 在另一个终端运行测试
python test_deduplication.py
```

测试脚本会：

- 🔍 发送包含重复内容的请求
- 📊 显示去重前后的统计信息
- ⏱️ 测量性能改进效果
- 🎵 验证最终音频的完整性

## 📋 日志输出示例

```
🔄 内容去重: 原始 8 个项目 → 去重后 5 个项目 (减少 3 个重复项目)
   📋 重复内容: '扇風機...' 出现 3 次 (位置: [0, 2, 6])
   📋 重复内容: 'ゼン...' 出现 2 次 (位置: [3, 5])
⚡ 使用智能并发处理模式 (项目数: 5, 并发数: 4, 格式: wav)
🔄 重建完整音频序列: 5 个唯一文件 → 8 个音频片段
```

## ⚙️ 配置选项

目前去重功能默认启用，无需额外配置。如需自定义行为，可以在 `config/tts_config.py` 中添加相关设置。

## 🔧 故障排除

### 常见问题

**Q: 去重会影响音频质量吗？**
A: 不会。去重只是避免重复合成，最终的音频文件完全相同。

**Q: 去重会改变音频顺序吗？**
A: 不会。系统会确保最终合成的音频序列与原始请求顺序完全一致。

**Q: 如何禁用去重功能？**
A: 目前去重功能是内置的优化，建议保持启用以获得最佳性能。

## 🎯 最佳实践

1. **📋 合理组织内容**: 将相同的内容放在一起，便于去重
2. **🎛️ 统一参数**: 对相同内容使用一致的语音参数
3. **📊 监控效果**: 关注 API 响应中的去重统计信息
4. **🧪 定期测试**: 使用测试脚本验证去重效果

---

通过智能去重功能，您的 TTS 服务现在可以更高效地处理包含重复内容的批量请求，大幅提升处理速度并节约资源！
